{% extends "base.html" %}
{% block lab %}–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 6{% endblock %}

{% block script %}
<script>
function getOfficeList() {
    const url = '/lab6/json-rpc-api/';
    const json = {
        'jsonrpc': '2.0',
        'method': 'info',
        'id': Math.round(Math.random()*1000)
    };
    fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(json)
    })
    .then(function(response) {
        return response.json()
    })
    .then(function(data) {
        const office_list = data.result;
        const ul = document.getElementById('office-list');
        const totalCostElement = document.getElementById('total-cost');
        
        ul.innerHTML = '';
        
        let totalCost = 0;
        const currentUser = "{{ login|safe }}";
        
        for (let i = 0; i < office_list.length; i++) {
            const office = office_list[i];
            const li = document.createElement('li');
            li.className = 'office-card';
            
            // –°—Ç–∞—Ç—É—Å –∫–∞–±–∏–Ω–µ—Ç–∞
            const statusClass = office.tenant ? 'office-status-booked' : 'office-status-free';
            const statusText = office.tenant ? `–ê—Ä–µ–Ω–¥–æ–≤–∞–Ω: ${office.tenant}` : '–°–≤–æ–±–æ–¥–µ–Ω';
            
            li.innerHTML = `
                <div class="office-header">
                    <span class="office-number">–ö–∞–±–∏–Ω–µ—Ç ‚Ññ${office.number}</span>
                    <span class="${statusClass}">${statusText}</span>
                </div>
                <div class="office-details">
                    <div class="office-price">
                        <i class="price-icon">üí∞</i>
                        <span>${office.price} —Ä—É–±./–º–µ—Å.</span>
                    </div>
                    <div class="office-actions">
                        ${!office.tenant 
                            ? `<button class="btn-book" onclick="booking(${office.number})">
                                   <i>üìã</i> –ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞—Ç—å
                               </button>`
                            : `<button class="btn-cancel" onclick="cancellation(${office.number})">
                                   <i>‚ùå</i> –û—Å–≤–æ–±–æ–¥–∏—Ç—å
                               </button>`
                        }
                    </div>
                </div>
            `;
            
            if (currentUser && office.tenant === currentUser) {
                totalCost += office.price;
            }

            ul.appendChild(li);
        }
        
        if (totalCost > 0 && currentUser) {
            totalCostElement.innerHTML = `
                <div class="total-cost-card">
                    <div class="total-cost-header">
                        <i>üìä</i>
                        <h3>–í–∞—à–∞ –∞—Ä–µ–Ω–¥–∞</h3>
                    </div>
                    <div class="total-cost-body">
                        <p>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤ –º–µ—Å—è—Ü:</p>
                        <div class="total-cost-amount">${totalCost} —Ä—É–±.</div>
                    </div>
                </div>
            `;
            totalCostElement.style.display = 'block';
        } else {
            totalCostElement.style.display = 'none';
        }
    })
    .catch(function(error) {
        console.error('–û—à–∏–±–∫–∞:', error);
    });
}

function booking(officeNumber) {
    const url = '/lab6/json-rpc-api/';
    const json = {
        'jsonrpc': '2.0',
        'method': 'booking',
        'params': officeNumber,
        'id': Math.round(Math.random() * 1000)
    };
    fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(json)
    })
    .then(function(response) {
        return response.json()
    })
    .then(function(data) {
        if (data.error) {
            switch (data.error.code) {
                case 1:
                    showNotification('–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –≤ —Å–∏—Å—Ç–µ–º–µ.', 'error');
                    break;
                case 2:
                    showNotification('–≠—Ç–æ—Ç –æ—Ñ–∏—Å —É–∂–µ –∞—Ä–µ–Ω–¥–æ–≤–∞–Ω.', 'warning');
                    break;
                case 3:
                    showNotification('–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –æ—Ñ–∏—Å–∞.', 'error');
                    break;
                case -32601:
                    showNotification('–ü—Ä–æ–∏–∑–æ—à–ª–∞ —Å–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞.', 'error');
                    break;
                default:
                    showNotification('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ' + data.error.message, 'error');
            }
        } else {
            showNotification('–û—Ñ–∏—Å —É—Å–ø–µ—à–Ω–æ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω!', 'success');
            getOfficeList();
        }
    })
    .catch(function(error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞.', 'error');
    });
}

function cancellation(officeNumber) {
    const url = '/lab6/json-rpc-api/';
    const json = {
        'jsonrpc': '2.0',
        'method': 'cancellation',
        'params': officeNumber,
        'id': Math.round(Math.random() * 1000)
    };
    fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(json)
    })
    .then(function(response) {
        return response.json()
    })
    .then(function(data) {
        if (data.error) {
            switch (data.error.code) {
                case 1:
                    showNotification('–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –≤ —Å–∏—Å—Ç–µ–º–µ.', 'error');
                    break;
                case 4:
                    showNotification('–≠—Ç–æ—Ç –æ—Ñ–∏—Å –Ω–µ –∞—Ä–µ–Ω–¥–æ–≤–∞–Ω.', 'warning');
                    break;
                case 5:
                    showNotification('–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ —Å–Ω—è—Ç—å —á—É–∂—É—é –∞—Ä–µ–Ω–¥—É.', 'error');
                    break;
                case 3:
                    showNotification('–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –æ—Ñ–∏—Å–∞.', 'error');
                    break;
                default:
                    showNotification('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ' + data.error.message, 'error');
            }
        } else {
            showNotification('–ê—Ä–µ–Ω–¥–∞ –æ—Ñ–∏—Å–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–º–µ–Ω–µ–Ω–∞!', 'success');
            getOfficeList();
        }
    })
    .catch(function(error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞.', 'error');
    });
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <div class="notification-content">
            ${type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ùå'}
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.classList.add('show');
    }, 10);
    
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

document.addEventListener('DOMContentLoaded', function() {
    getOfficeList();
});

</script>

<style>
.office-system {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.office-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin: 30px 0;
    list-style: none;
    padding: 0;
}

.office-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    border: 1px solid #eaeaea;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.office-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
}

.office-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 2px solid #f5f5f5;
}

.office-number {
    font-size: 1.4em;
    font-weight: 700;
    color: #2c3e50;
    background: linear-gradient(45deg, #3498db, #2c3e50);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.office-status-free {
    background: #e8f5e9;
    color: #27ae60;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.9em;
    font-weight: 600;
}

.office-status-booked {
    background: #fff3e0;
    color: #f39c12;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.9em;
    font-weight: 600;
}

.office-details {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.office-price {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 1.2em;
    font-weight: 700;
    color: #e74c3c;
}

.price-icon {
    font-size: 1.4em;
}

.btn-book, .btn-cancel {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.95em;
}

.btn-book {
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
}

.btn-book:hover {
    background: linear-gradient(135deg, #2980b9, #1c5980);
    transform: scale(1.05);
}

.btn-cancel {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
}

.btn-cancel:hover {
    background: linear-gradient(135deg, #c0392b, #a93226);
    transform: scale(1.05);
}

.user-info-card {
    background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
    border-radius: 12px;
    padding: 20px;
    margin: 20px 0;
    border: 1px solid #a5d6a7;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.warning-card {
    background: linear-gradient(135deg, #fff3cd, #ffeaa7);
    border-radius: 12px;
    padding: 20px;
    margin: 20px 0;
    border: 1px solid #ffd54f;
}

.register-card {
    background: linear-gradient(135deg, #f5f5f5, #e0e0e0);
    border-radius: 12px;
    padding: 25px;
    margin-top: 30px;
    text-align: center;
}

.total-cost-card {
    background: linear-gradient(135deg, #e3f2fd, #bbdefb);
    border-radius: 12px;
    padding: 25px;
    margin-top: 30px;
    border: 2px solid #90caf9;
    animation: fadeIn 0.5s ease;
}

.total-cost-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
}

.total-cost-header i {
    font-size: 2em;
    background: linear-gradient(45deg, #2196f3, #0d47a1);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.total-cost-header h3 {
    margin: 0;
    color: #1565c0;
    font-size: 1.5em;
}

.total-cost-body {
    text-align: center;
}

.total-cost-amount {
    font-size: 2.5em;
    font-weight: 800;
    color: #e74c3c;
    margin: 10px 0;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
}

.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: white;
    border-radius: 10px;
    padding: 15px 20px;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
    z-index: 1000;
    opacity: 0;
    transform: translateX(100%);
    transition: all 0.3s ease;
    max-width: 350px;
}

.notification.show {
    opacity: 1;
    transform: translateX(0);
}

.notification-success {
    border-left: 5px solid #27ae60;
    background: #e8f5e9;
}

.notification-error {
    border-left: 5px solid #e74c3c;
    background: #ffebee;
}

.notification-warning {
    border-left: 5px solid #f39c12;
    background: #fff3e0;
}

.notification-content {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 500;
}

.main-title {
    text-align: center;
    margin: 20px 0 40px;
    color: #2c3e50;
    font-size: 2.5em;
    position: relative;
    padding-bottom: 15px;
}

.main-title::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 100px;
    height: 4px;
    background: linear-gradient(90deg, #3498db, #2c3e50);
    border-radius: 2px;
}

.section-title {
    color: #34495e;
    margin: 30px 0 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #ecf0f1;
}

.action-link {
    display: inline-block;
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
    padding: 10px 25px;
    border-radius: 25px;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.3s ease;
    margin-top: 10px;
}

.action-link:hover {
    background: linear-gradient(135deg, #2980b9, #1c5980);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@media (max-width: 768px) {
    .office-list {
        grid-template-columns: 1fr;
    }
    
    .main-title {
        font-size: 2em;
    }
    
    .office-details {
        flex-direction: column;
        gap: 15px;
        align-items: stretch;
    }
    
    .office-price {
        justify-content: center;
    }
    
    .btn-book, .btn-cancel {
        width: 100%;
        justify-content: center;
    }
}
</style>

{% endblock %}

{% block main %}
<div class="office-system">
    <h1 class="main-title">üè¢ –°–∏—Å—Ç–µ–º–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ñ–∏—Å–æ–≤</h1>
    
    {% if login %}
        <div class="user-info-card">
            <div>
                <h3 style="margin: 0; color: #27ae60;">üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h3>
                <p style="margin: 5px 0 0; color: #555;">–í—ã –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã –∫–∞–∫: <strong>{{ login }}</strong></p>
            </div>
        </div>
    {% else %}
        <div class="warning-card">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="font-size: 1.8em;">üîí</div>
                <div>
                    <h3 style="margin: 0; color: #f39c12;">–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h3>
                    <p style="margin: 5px 0 0; color: #555;">
                        –î–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ñ–∏—Å–æ–≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É.
                    </p>
                </div>
            </div>
            <a href="/lab5/login" class="action-link">–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</a>
        </div>
    {% endif %}
    
    <h2 class="section-title">üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –æ—Ñ–∏—Å—ã</h2>
    <ul class="office-list" id="office-list"></ul>
    
    <div id="total-cost"></div>
    
    {% if not login %}
    <div class="register-card">
        <h3 style="margin: 0 0 15px; color: #555;">–ï—â—ë –Ω–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞?</h3>
        <p style="margin: 0 0 20px; color: #777;">
            –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º —Å–∏—Å—Ç–µ–º—ã –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.
        </p>
        <a href="/lab5/register" class="action-link">üìù –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
    </div>
    {% endif %}
</div>
{% endblock %}